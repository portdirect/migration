#!/bin/sh
. /opt/harbor/scripts/environment-variables

KUBE_MANIFESTS_DIR=/etc/kubernetes/manifests
TEMPLATE_MANIFESTS_DIR=/etc/harbor/kubernetes/manifests

prep_manifest () {
  COMPONENT_MANIFEST=$1
  sed "s/{{EXPOSED_IP}}/${EXPOSED_IP}/g" ${TEMPLATE_MANIFESTS_DIR}/${ROLE}/${COMPONENT_MANIFEST} > /tmp/${COMPONENT_MANIFEST}

  sed -i "s/{{NODE_PRIMARY_DEV}}/${NODE_PRIMARY_DEV}/g" ${TEMPLATE_MANIFESTS_DIR}/${ROLE}/${COMPONENT_MANIFEST} /tmp/${COMPONENT_MANIFEST}
  sed -i "s/{{NODE_IP}}/${NODE_IP}/g" ${TEMPLATE_MANIFESTS_DIR}/${ROLE}/${COMPONENT_MANIFEST} /tmp/${COMPONENT_MANIFEST}
  sed -i "s/{{NODE_PUBLIC_IP}}/${NODE_PUBLIC_IP}/g" ${TEMPLATE_MANIFESTS_DIR}/${ROLE}/${COMPONENT_MANIFEST} /tmp/${COMPONENT_MANIFEST}

  sed -i "s/{{ETCD_SERVICE_HOST}}/${ETCD_SERVICE_HOST}/g" ${TEMPLATE_MANIFESTS_DIR}/${ROLE}/${COMPONENT_MANIFEST} /tmp/${COMPONENT_MANIFEST}

  sed -i "s/{{OVS_SB_DB_IP}}/${OVS_SB_DB_IP}/g" ${TEMPLATE_MANIFESTS_DIR}/${ROLE}/${COMPONENT_MANIFEST} /tmp/${COMPONENT_MANIFEST}
  sed -i "s/{{OVS_NB_DB_IP}}/${OVS_NB_DB_IP}/g" ${TEMPLATE_MANIFESTS_DIR}/${ROLE}/${COMPONENT_MANIFEST} /tmp/${COMPONENT_MANIFEST}
  sed -i "s/{{OVN_L3_MODE}}/${OVN_L3_MODE}/g" ${TEMPLATE_MANIFESTS_DIR}/${ROLE}/${COMPONENT_MANIFEST} /tmp/${COMPONENT_MANIFEST}

  sed -i "s/{{KUBE_SERVICE_HOST}}/${KUBE_SERVICE_HOST}/g" ${TEMPLATE_MANIFESTS_DIR}/${ROLE}/${COMPONENT_MANIFEST} /tmp/${COMPONENT_MANIFEST}

  sed -i "s/{{RABBITMQ_SERVICE_HOST}}/${RABBITMQ_SERVICE_HOST}/g" ${TEMPLATE_MANIFESTS_DIR}/${ROLE}/${COMPONENT_MANIFEST} /tmp/${COMPONENT_MANIFEST}

  sed -i "s/{{MEMCACHED_SERVICE_HOST}}/${MEMCACHED_SERVICE_HOST}/g" ${TEMPLATE_MANIFESTS_DIR}/${ROLE}/${COMPONENT_MANIFEST} /tmp/${COMPONENT_MANIFEST}

  sed -i "s/{{MARIADB_SERVICE_HOST}}/${MARIADB_SERVICE_HOST}/g" ${TEMPLATE_MANIFESTS_DIR}/${ROLE}/${COMPONENT_MANIFEST} /tmp/${COMPONENT_MANIFEST}

  sed -i "s/{{KEYSTONE_SERVICE_HOST}}/${KEYSTONE_SERVICE_HOST}/g" ${TEMPLATE_MANIFESTS_DIR}/${ROLE}/${COMPONENT_MANIFEST} /tmp/${COMPONENT_MANIFEST}

  sed -i "s/{{NEUTRON_SERVICE_HOST}}/${NEUTRON_SERVICE_HOST}/g" ${TEMPLATE_MANIFESTS_DIR}/${ROLE}/${COMPONENT_MANIFEST} /tmp/${COMPONENT_MANIFEST}

  sed -i "s/{{NOVA_SERVICE_HOST}}/${NOVA_SERVICE_HOST}/g" ${TEMPLATE_MANIFESTS_DIR}/${ROLE}/${COMPONENT_MANIFEST} /tmp/${COMPONENT_MANIFEST}
  sed -i "s/{{NOVA_METADATA_SERVICE_HOST}}/${NOVA_METADATA_SERVICE_HOST}/g" ${TEMPLATE_MANIFESTS_DIR}/${ROLE}/${COMPONENT_MANIFEST} /tmp/${COMPONENT_MANIFEST}

  sed -i "s/{{GLANCE_SERVICE_HOST}}/${GLANCE_SERVICE_HOST}/g" ${TEMPLATE_MANIFESTS_DIR}/${ROLE}/${COMPONENT_MANIFEST} /tmp/${COMPONENT_MANIFEST}
  sed -i "s/{{GLANCE_REGISTRY_SERVICE_HOST}}/${GLANCE_REGISTRY_SERVICE_HOST}/g" ${TEMPLATE_MANIFESTS_DIR}/${ROLE}/${COMPONENT_MANIFEST} /tmp/${COMPONENT_MANIFEST}

  sed -i "s/{{OCTAVIA_SERVICE_HOST}}/${OCTAVIA_SERVICE_HOST}/g" ${TEMPLATE_MANIFESTS_DIR}/${ROLE}/${COMPONENT_MANIFEST} /tmp/${COMPONENT_MANIFEST}
  sed -i "s/{{OCTAVIA_HEALTH_SERVICE_HOST}}/${OCTAVIA_HEALTH_SERVICE_HOST}/g" ${TEMPLATE_MANIFESTS_DIR}/${ROLE}/${COMPONENT_MANIFEST} /tmp/${COMPONENT_MANIFEST}

  sed -i "s/{{CINDER_SERVICE_HOST}}/${CINDER_SERVICE_HOST}/g" ${TEMPLATE_MANIFESTS_DIR}/${ROLE}/${COMPONENT_MANIFEST} /tmp/${COMPONENT_MANIFEST}

  cat /tmp/${COMPONENT_MANIFEST} > ${KUBE_MANIFESTS_DIR}/${COMPONENT_MANIFEST}

}

prep_manifests () {
  ROLE=$1
  COMPONENTS="$(ls ${TEMPLATE_MANIFESTS_DIR}/${ROLE})"
  for COMPONENT in $COMPONENTS; do
    prep_manifest ${COMPONENT}
  done
}
