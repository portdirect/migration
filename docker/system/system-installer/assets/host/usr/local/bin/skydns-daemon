#!/bin/bash
set -e
PATH=${PATH}:/usr/local/bin
source /etc/harbor/network.env

DOCKER_BOOTSTRAP_IP=$(echo ${DOCKER_BOOTSTRAP_NETWORK} | awk -F '/' '{print $1}')

cat > /etc/resolv-ext.conf <<EOF
nameserver ${EXTERNAL_DNS}
nameserver ${EXTERNAL_DNS_1}
EOF

if [ -f /etc/master-node ]
  then
    if etcdctl-network ls ; then
        echo "Command succeeded"
    else
        echo "Command failed"
        docker-bootstrap stop bootstrap-etcd-network || true
        docker-bootstrap rm bootstrap-etcd-network || true
        docker-bootstrap run -d \
            --name bootstrap-etcd-network \
            -p 127.0.0.1:4001:4001 \
            -p 127.0.0.1:7001:7001 \
            -v /var/lib/harbor/etcd/network:/var/etcd:rw \
            -v /etc/harbor/auth/etcd-network/ca.crt:/etc/os-ssl/ca:ro \
            -v /etc/harbor/auth/etcd-network/etcd-network.crt:/etc/os-ssl/cirt:ro \
            -v /etc/harbor/auth/etcd-network/etcd-network.key:/etc/os-ssl/key:ro \
            docker.io/port/system-etcd:latest \
                etcd \
                --name=master \
                --data-dir=/var/etcd \
                --listen-client-urls=https://0.0.0.0:4001 \
                --listen-peer-urls=https://0.0.0.0:7001 \
                --advertise-client-urls=https://etcd-network.${OS_DOMAIN}:4001 \
                --initial-advertise-peer-urls="https://$(hostname -s).${OS_DOMAIN}:7001" \
                --initial-cluster="master=https://$(hostname -s).${OS_DOMAIN}:7001" \
                --initial-cluster-token='etcd-cluster' \
                --ca-file=/etc/os-ssl/ca \
                --cert-file=/etc/os-ssl/cirt \
                --key-file=/etc/os-ssl/key \
                --peer-ca-file=/etc/os-ssl/ca \
                --peer-cert-file=/etc/os-ssl/cirt \
                --peer-key-file=/etc/os-ssl/key
    fi
fi

docker-bootstrap stop skydns || true
docker-bootstrap kill skydns || true
docker-bootstrap rm -v skydns || true
docker-bootstrap run \
    --name skydns \
    -d \
    --net=host \
    -p ${DOCKER_BOOTSTRAP_IP}:53:53 \
    -v /etc/resolv-ext.conf:/etc/resolv.conf:ro \
    -v /etc/harbor/auth/host/ca.crt:/etc/os-ssl/ca:ro \
    -v /etc/harbor/auth/host/host.crt:/etc/os-ssl/cirt:ro \
    -v /etc/harbor/auth/host/host.key:/etc/os-ssl/key:ro \
    docker.io/port/system-skydns:latest \
        -addr="${DOCKER_BOOTSTRAP_IP}:53" \
        -nameservers="${EXTERNAL_DNS}:53" \
        -machines="https://etcd-network.${OS_DOMAIN}:4001" \
        -ca-cert="/etc/os-ssl/ca" \
        -tls-pem="/etc/os-ssl/cirt" \
        -tls-key="/etc/os-ssl/key"


until dig skydns.local @${DOCKER_BOOTSTRAP_IP}
do
  echo "Waiting for SKYDNS to respond"
  sleep 2
done
echo "nameserver ${DOCKER_BOOTSTRAP_IP}" > /etc/resolv.conf
echo "# Generated by HarborOS" >> /etc/resolv.conf
